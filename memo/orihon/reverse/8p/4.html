<head>
<meta charset="UTF-8">
<style>
@page {
    size: A4 landscape; /*landscape/portrait  793,1122px(CSSは1in=96pxなのでそれに合わせた)*/
    margin: 0mm 5mm;
}
:root {
    --font-size: 16px;
    --letter-spacing: 0.05em;
    --line-height: 1.5em;
    --writing-mode: vertical-rl;
    --text-orientation: upright;
    --page-inline-size: 0px;
    --page-block-size: 0px;
}
body {
    margin:0; padding:0;
}
h1,h2,h3,h4,h5,h6,th,label,caption,legend,code { font-family: 'Noto Sans JP', 'Source Han Sans JP', 'Noto Color Emoji', sans-serif; }
.page *:first-child {margin-block-start:0;}
.page *:last-child {margin-block-end:0;}
em {
    font-style: normal;
    text-emphasis: var(--em-style) var(--em-color);
    -webkit-text-emphasis: var(--em-style) var(--em-color);
}
.paper {
    width: 1122px;
    height: 793px;
    display: grid; 
    /*
    grid-template-rows: repeat(2, 1fr);
    grid-template-columns: repeat(4, 1fr);
    */
    grid-template-rows: repeat(2, 396.5px);
    grid-template-columns: repeat(4, 280.5px);
    box-sizing: border-box;
    padding: 0; margin:0;
}
.page {
    width:280.5px; height:396.5px;
    max-width:280.5px; max-height:396.5px;
    writing-mode: var(--writing-mode);
    text-orientation: var(--text-orientation);
    font-size: var(--font-size);
    letter-spacing: var(--letter-spacing);
    line-height: var(--line-height);
    padding: 0; margin:0;
    font-feature-settings: "palt"; /*カーニング 字間詰め*/
}
.reverse {
    transform: scale(-1, -1);
}
</style>
<script src="../../../../docs/lib/util/type.js"></script>
<script src="../../../../docs/lib/util/string/trim.js"></script>
<script src="../../../../docs/lib/util/string/case.js"></script>
<script src="../../../../docs/lib/util/string/length.js"></script>
<script src="../../../../docs/lib/util/dom/dom.tags.js"></script>
<script src="parser.js"></script>
<script src="splitter.js"></script>
<script>
window.addEventListener('DOMContentLoaded', async(e)=>{
    let OBJ_URL = null;
    const parser = new JavelParser(document.querySelector(`[name="manuscript"]`).value);
    const splitter = (new PageTypes()).get('novel');
    console.log(splitter, new PageTypes().ids)
    splitter.target = document.querySelector(`.splitter`);
    console.log(splitter.target);
    function pt2px(pt) {return pt/72 * 96}//1pt=1/72in, 1in=96px
    function em2px(em) {return em * pt2px(Number(document.querySelector(`[name="fontSize"]`).value))}//1pt=1/72in, 1in=96px
    document.querySelector(`[name="fontSize"]`).addEventListener('input', async(e)=>{
        const S = document.documentElement.style;
        const s = S.setProperty.bind(S);
        const px = pt2px(e.target.value); // Math.round(px)
        console.log(px);
        s('--font-size', `${px}`);
        document.querySelector(`[name="fontSizePx"]`).textContent = `${px.toFixed(2)}`;

        console.log(document.querySelector(`.page`));
        const is = parseFloat(getComputedStyle(document.querySelector(`.page`)).getPropertyValue('inline-size'));
        const bs = parseFloat(getComputedStyle(document.querySelector(`.page`)).getPropertyValue('block-size'));
        const sp = em2px(Number(document.querySelector(`[name="letterSpacing"]`).value));
        console.log(is, bs, px, sp);
        document.querySelector(`[name="lineOfChars"]`).textContent = `${Math.floor(is / ((px + sp)*1.2))}`;//1.2は適当な係数
        console.log(is)
    });
    document.querySelector(`[name="letterSpacing"]`).addEventListener('input', async(e)=>{
        const S = document.documentElement.style;
        const s = S.setProperty.bind(S);
        s('--letter-spacing', `${e.target.value}em`);
        console.log(getComputedStyle(document.querySelector(`.page`)).getPropertyValue('--letter-spacing'));
    });
    document.querySelector(`[name="lineHeight"]`).addEventListener('input', async(e)=>{
        const S = document.documentElement.style;
        const s = S.setProperty.bind(S);
        s('--line-height', `${e.target.value}em`);
        console.log(getComputedStyle(document.querySelector(`.page`)).getPropertyValue('--line-height'));
    });

    function makePaperHtml() {
        if (OBJ_URL) {removePaperHtml()}
        const head = document.createElement('head');
        const meta = document.createElement('meta');
        meta.setAttribute('charset', 'UTF-8');
        head.append(meta, document.importNode(document.documentElement.querySelector('head style'),true));
        const body = document.createElement('body');
        const script = document.createElement('script');
        script.textContent = `window.print()`;
        const paper = document.importNode(document.documentElement.querySelector('body .paper'),true);
        body.append(paper, script);
        const blob = new Blob([head.outerHTML + body.outerHTML], {type:'text/html'});
        OBJ_URL = URL.createObjectURL(blob);
        console.log(OBJ_URL);
        const w = window.open(OBJ_URL);
    }
    function removePaperHtml() {console.log('前回の印刷紙面データを削除した。');URL.revokeObjectURL(OBJ_URL)}
    document.querySelector(`[name="make"]`).addEventListener('click', async(e)=>makePaperHtml());
    document.querySelector(`[name="writingMode"]`).addEventListener('input', async(e)=>{
        const S = document.documentElement.style;
        const s = S.setProperty.bind(S);
        const wm = e.target.value;
        const to = 'horizontal-tb'===wm ? 'mixed' : 'upright';
        s('--writing-mode', `${wm}`);
        s('--text-orientation', `${to}`);
    });

    let debounceScriptInputTimer = null;
    document.querySelector(`[name="manuscript"]`).addEventListener('input', async(e)=>{// ページ分割処理
        clearTimeout(debounceScriptInputTimer);
        debounceScriptInputTimer = setTimeout(async()=>{// 入力後２秒間経っても再びinputイベントが発火しなければ発火させる。
            splitter.target = document.querySelector(`.page[data-page="1"]`);
            parser.text = e.target.value;
            const pages = splitter.make(parser.els);
            console.log(pages);
            pages.map((p,i)=>{
                if (i<8) {
                    document.querySelector(`.paper .page[data-page="${i+1}"]`).innerHTML = p.innerHTML;
                }
            });
            for (let i=pages.length; i<8; i++) {
                document.querySelector(`[data-page="${i+1}"]`).innerHTML = ''
            }

            /*
            for ()


            console.log(parser.text);
            console.log(parser.blocks);
            console.log(parser.els);
            document.querySelector(`.splitter`).style.display='block';
            splitter.make(parser.els);
            splitter.redom(parser.els);
//            splitter.make(parser.els);
//            await splitter.update(parser.els);
//            document.querySelector(`.splitter`)
//            splitter.get('novel').;
            let pageNum = 0;
//            for (let page of document.querySelector(`.splitter`).children) {document.querySelector(`[data-page="${page}"]`).innerHTML = ''}
            for (let page of document.querySelector(`.splitter`).children) {
                pageNum++;
                if (8 < pageNum) {break}
                const target = document.querySelector(`.paper .page[data-page="${pageNum}"]`);
                target.innerHTML = page.innerHTML;
                console.log(target);
//                while(page.firstChild) {target.append(page.firstChild)}
//                target.innerHTML = 'xxxx';
//                target.append('yyyyyy');
//                console.log(pageNum, page, page.innerHTML, document.querySelector(`.paper .page[data-page="${pageNum}"]`));
//                document.querySelector(`.paper .page[data-page="${pageNum}"]`).innerHTML = page.innerHTML;
//                for (let child of page.childNodes)
            }
            for (let i=pageNum+1; i<9; i++) {
                document.querySelector(`[data-page="${i}"]`).innerHTML = ''
            }
            document.querySelector(`.splitter`).style.display='none';
            /*
            */
        }, 2000);
    });

    document.querySelector(`[name="fontSize"]`).dispatchEvent(new Event('input'));
    document.querySelector(`[name="fontSize"]`).focus();
});
</script>
</head>
<body>
<h1>折本p8 A4</h1>
<input name="fontSize" type="number" min="8" max="14" step="0.5" value="12">pt(<span name="fontSizePx"></span>px)　<span name="lineOfChars"></span>字/行
<input name="letterSpacing" type="number" min="0" max="0.2" step="0.01" value="0.05">em(字間)
<input name="lineHeight" type="number" min="1" max="1.8" step="0.05" value="1.7">em(行間)
<select name="writingMode"><option value="vertical-rl">縦書き</option><option value="horizontal-tb">横書き</option></select>
<button name="make">面付けする</button>(押下後に出現した画面で右クリックし『印刷する』)<!--印刷用紙面生成-->
<br>
<textarea name="manuscript" style="width:100%;"># タイトル

　本文。</textarea>

<div class="paper">
<div class="page reverse" data-page="7">⑦この本文を上下左右逆さまに表示したい。折本8pを作る時に必要となる。</div>
<div class="page reverse" data-page="6">⑥この本文を上下左右逆さまに表示したい。折本8pを作る時に必要となる。</div>
<div class="page reverse" data-page="5">⑤この本文を上下左右逆さまに表示したい。折本8pを作る時に必要となる。</div>
<div class="page reverse" data-page="4">④この本文を上下左右逆さまに表示したい。折本8pを作る時に必要となる。</div>
<div class="page" data-page="8">⑧ここは逆転させず正常に表示したい。</div>
<div class="page" data-page="1">①ここは逆転させず正常に表示したい。</div>
<div class="page" data-page="2">②ここは逆転させず正常に表示したい。</div>
<div class="page" data-page="3">③ここは逆転させず正常に表示したい。</div>
</div>

<!--
<div class="dummy paper">
<div class="page reverse" data-page="7"></div>
<div class="page reverse" data-page="6"></div>
<div class="page reverse" data-page="5"></div>
<div class="page reverse" data-page="4"></div>
<div class="page" data-page="8"></div>
<div class="page" data-page="1"></div>
<div class="page" data-page="2"></div>
<div class="page" data-page="3"></div>
</div>
-->

</body>

